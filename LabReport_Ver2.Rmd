---
title: "Lab Report Ver2"
author: "Aaron Willcox"
date: "03/08/2018"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Included Library, echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Included librarys for functions
library(psych)
library(haven)
library(dplyr)
library(lmSupport)
library(papaja)
library(broom)
library(tableone)
library(tictoc)
tic("Running")
```

**DV:** Personal Wellbeing Index (pwi)  
**IVs:** Affect(affect HPMood), Cogniton(cognition, MDT), Gender(gender), Personality(personality)

## Traits have not been reversed coded and I am unsure of the actual order of personality questions as the data was from last term. 

***

```{r Import}
well_being_df <- read_sav("data/WellbeingFINAL.sav")

```

```{r Check Data}
nrows <- nrow(well_being_df)
ncomplete <- sum(complete.cases(well_being_df))
ncomplete/nrows

# Check for missing or na data
which(is.na(well_being_df))
```


As per the PWI manual: score/number of domains*10 to get a SWB score. 
Then mutate this to a new column called "PW.Index"
```{r PWI Score}
well_being_df <- well_being_df %>% 
  mutate(PW.Index = (
    PWI1 + 
      PWI2 + 
      PWI3 + 
      PWI4 + 
      PWI5 + 
      PWI6 + 
      PWI7)/7*10)
```


Personality scores for each trait(O,C,E,A,N) are taken for each group of 10. 
These are summed and mutated to a new column for each trait.

```{r Personality}
# Personality Traits
well_being_df <- well_being_df %>% 
  mutate(Openness = ( # Openness
    Personality1 + 
      Personality2 +
      Personality3 +
      Personality4 +
      Personality5 +
      Personality6 +
      Personality7 +
      Personality8 +
      Personality9 +
      Personality10), 
    Conscientiousness = ( # Conscientiousness
      Personality11 + 
        Personality12 +
        Personality13 +
        Personality14 +
        Personality15 +
        Personality16 +
        Personality17 +
        Personality18 +
        Personality19 +
        Personality20),
    Extraversion = ( # Extraversion
      Personality21 + 
        Personality22 +
        Personality23 +
        Personality24 +
        Personality25 +
        Personality26 +
        Personality27 +
        Personality28 +
        Personality29 +
        Personality30),
    Agreeableness = ( # Agreeableness
      Personality31 + 
        Personality32 +
        Personality33 +
        Personality34 +
        Personality35 +
        Personality36 +
        Personality37 +
        Personality38 +
        Personality39 +
        Personality40),
    Neuroticism  = (  # Neuroticism
      Personality41 + 
        Personality42 +
        Personality43 +
        Personality44 +
        Personality45 +
        Personality46 +
        Personality47 +
        Personality48 +
        Personality49 +
        Personality50))

well_being_df <- well_being_df %>%  #personality group
  mutate(Personality = 
           (Personality1 +
           Personality2 +
           Personality3 + 
           Personality4 +
           Personality5 +
           Personality6 +
           Personality7 +
           Personality8 +
           Personality9 +
           Personality10 +
           Personality11 + 
           Personality12 +
           Personality13 +
           Personality14 +
           Personality15 +
           Personality16 +
           Personality17 +
           Personality18 +
           Personality19 +
           Personality20 +
           Personality21 + 
           Personality22 +
           Personality23 +
           Personality24 +
           Personality25 +
           Personality26 +
           Personality27 +
           Personality28 +
           Personality29 +
           Personality30 +
           Personality31 + 
           Personality32 +
           Personality33 +
           Personality34 +
           Personality35 +
           Personality36 +
           Personality37 +
           Personality38 +
           Personality39 +
           Personality40 +
           Personality41 + 
           Personality42 +
           Personality43 +
           Personality44 +
           Personality45 +
           Personality46 +
           Personality47 +
           Personality48 +
           Personality49 +
           Personality50)/50*10)
     
```

Homeostatically Protected Mood (Core Affect) as a measuer by Davern., et, al. that asks how people 
feel about life in general across three domains of "happy", "content" & "excited/alert".
Here the relevant columns are pulled, summed, divided by the 3 domains and mutated to a new column
called "affect". 
```{r HPMood}
well_being_df <- well_being_df %>% 
  mutate(affect = 
           (Affect1 + # happy
              Affect2 + # content
              Affect3)) # excited

```


Multiple Discrepancies Theory (MDT) - Cognition 
Firstly I mutate to a new column labelled "MDT" and averaged. 
Then each discrepancy mean is worked out and stored in its variable. 

1. self_wants 
2. self_other 
3. self_deserves
4. self_needs 
5. self_progress
6. self_future
7. self_past  

```{r MDT}
# This will create a new variable with the overal MDT cognition mean score
well_being_df <- well_being_df %>%  
  mutate(MDT =  (
    Cognition1 +
      Cognition2 +
      Cognition3 +
      Cognition4 +
      Cognition5 +
      Cognition6 +
      Cognition7)/7
  )

# Rename columns to refelct the discrepancies 
well_being_df <- well_being_df %>% 
  mutate(self_wants =     Cognition1,
         self_other =   Cognition2,
         self_deserves = Cognition3,
         self_needs =    Cognition4,
         self_progress = Cognition5,
         self_future =    Cognition6,
         self_past =    Cognition7)



```

### Descriptives of key variables
```{r Descriptives}
Descriptives <- describe(well_being_df[71:86]) #Using the brackets to call on the rows that were mutated to the dataframe

# Making use of the stargazer library to output a nicer looking table for html
# Cummins et.al, 2009 showed that the population SWB mean 74.93 and SD = 12.36.
stargazer(Descriptives, 
          title = "Descriptives",
          type = "text", 
          style = "all", 
          summary = FALSE, 
          ci = FALSE, digits = 2)
```

Looking at the discriptives things look pretty ok in terms of skew.
The main response variable is negatively skewed however, given the population mean
is up around 70s then this looks ok. Regression is pretty robust to some skewness.  
```{r Hist}
hist(well_being_df$PW.Index) #PWI histogram
```



### Next I will have a look at the plots and distributions of the Big 5, MDT and Cognition: 

```{r Plots}
# Create an object with the requrired columns
boxplot_big5 <- cbind(well_being_df$Openness, 
                    well_being_df$Conscientiousness, 
                    well_being_df$Extraversion, 
                    well_being_df$Agreeableness, 
                    well_being_df$Neuroticism)
#in order to name the boxplot more clearly, create an object with the names
boxplot_names_big5 <- c("O", "C", "E", "A", "N")

# Create a boxplot and use the object boxplot_names_big5 to label each one
boxplot(boxplot_big5, main = "Big 5 Means", names = boxplot_names_big5, horizontal = FALSE) 

# check the distribution of personality as a group
hist(well_being_df$Personality) #personality as a group plot

# Create an object for MDT variables, name and display box plot.
boxplot_mdt <- cbind(
  well_being_df$self_deserves,
  well_being_df$self_future,
  well_being_df$self_needs,
  well_being_df$self_other,
  well_being_df$self_past,
  well_being_df$self_progress,
  well_being_df$self_wants)


boxplot_names_mdt <- c("deserves", "future", "needs", "other", "past", "progress", "wants")

boxplot(boxplot_mdt, main = "Multiple Disc. Theory", names = boxplot_names_mdt, horizontal = FALSE) 

# HPMood 
boxplot_hpmood <- cbind(
  well_being_df$Affect1,
  well_being_df$Affect2,
  well_being_df$Affect3
)

boxplot_hpmood_names <- c("Happy", "Content", "Excited")

boxplot(boxplot_hpmood, main = "HPMood", names = boxplot_hpmood_names, horizontal = FALSE)


```

Big 5 boxplot variations between each trait seem good. Even personality traits from survey participants suggesting no one dominant personality. Neuroticism has a few outliers though

Ranges of scores were pretty even except for *self_deserves* and *self_future*. These score feel short of the upper quartile comparitively with the other variables. The scores median scores for *deserves* and *needs* both sitting on the 25th percentile line suggesting a large range of preference for that score. 

HPmood has a good distribution of scores, nothing to see here, move along. 


## Correlations

Combine into an object variables of interest. Using cbind as calling variables with well_being_df$... removes col names for some reason

```{r Correlations}
# Check correlations with cronbachs alpha
alpha_big5 <- boxplot_big5
alpha_big5 <- alpha(alpha_big5)
alpha_big5$total$raw_alpha #raw alpha score - have not reversed score!! wait for real data

alpha_hpmood <- boxplot_hpmood
alpha_hpmood <- alpha(alpha_hpmood)
alpha_hpmood$total$raw_alpha #raw alpha score

# Given the amount of IVs in the design will use omega value which also spits out alpha
Omega_Personality <- cbind(well_being_df[72:76])
omega(Omega_Personality)

Omega_MDT <- cbind(well_being_df[80:86])
omega(Omega_MDT)

Group.Corr <- well_being_df[71:86] 

# Check all the correlations in a matrix
round(cor(Group.Corr, use = "pair"), 2) 

```


Openess was negatively assocaited with PWI scores (-0.32), neuroticism
had a slight negative association but the remainder of the big 5 traits had little association.
Strongest correlation was that of affect followed by MDT. 
Break down of the discrepancies: all were moderatly correlated with PWI scores except for self future. Perhaps the inability to affectively forecast isnt reliable indicator of SWB? 

### Regression
Step one of the multiple regression will use the two strongest correlates followed by the big
5 then MDT. 

```{r Regression}

Gender_labels <- c("Male", "Female", "Transgender") #set labels for gender factor levels

model1 <- lm(PW.Index ~ Age 
             + factor(Gender)
             , data = well_being_df) #baseline obtain total SS

model2 <- lm(PW.Index ~ Age 
             + Gender 
             + affect 
             + MDT
             , data = well_being_df) #use known sign effects first based on previous research

model3 <- lm(PW.Index ~ Age 
             + factor(Gender, labels = Gender_labels) 
             + affect 
             + MDT 
             + Openness 
             + Conscientiousness 
             + Extraversion 
             + Agreeableness 
             + Neuroticism
             , data = well_being_df) #additional of personality constructs - not sig

model4 <- lm(PW.Index ~ Age + #model without overall MDT effect and with discrepancies
               + factor(Gender, labels = Gender_labels) 
             + affect
             + self_wants 
             + self_other 
             + self_deserves
             + self_needs 
             + self_progress
             + self_future
             + self_past
             , data = well_being_df) 


model5 <- lm(PW.Index ~ Age + #model without overall MDT effect and with discrepancies and Big5
               + factor(Gender, labels = Gender_labels)
             + affect
             + Openness 
             + Conscientiousness
             + Extraversion 
             + Agreeableness
             + Neuroticism
             + self_wants 
             + self_other 
             + self_deserves
             + self_needs 
             + self_progress
             + self_future
             + self_past
             , data = well_being_df) #62% variance. self_best/future are sig

#removing Big Five constructs has 0.6066 then adding has 0.6169. 2% difference
#using only the extraveriosn and neurotic traits is where the 2% additoinal variance is coming form. 

#run model 4 again with the additional Personality as a group
model6 <- lm(PW.Index ~ Age
             +  factor(Gender, labels = Gender_labels)
             +  affect
             +  Personality
             +  self_wants 
             +  self_other 
             +  self_deserves
             +  self_needs 
             +  self_progress
             +  self_future
             +  self_past
             , data = well_being_df) 


#Hierachial regression 
summary(model1) #PWI ~ age and gender.
summary(model2) #sig p <.0001 affect and MDT as a group
summary(model3) #Big 5 no significance from ANOVA
summary(model4) #sig p<.0001. affect and self_other 
summary(model5) 
summary(model6)

# Run an ANOVA to check for sig effect. 
anova(model1, model2, model3, model4, model5, model6)

# personality still non sig

effect_sizes_model4 <- modelEffectSizes(model4, Digits = 2) #check effect sizes and partials


```

## Model Improvement
using the step() function to see if there are variables which can be removed by comparing the model with all teh nested models. Step picks up the best fit by dropping models and repeating the process until it has the best fit. 

```{r Best Fit}
step(model6, test = "F") #step through each variable to test for best fit

# Age, Self wants, self other and affect were the best fit. 
best_fit_SWB <- lm(PW.Index ~ 
                     Age 
                   + self_wants 
                   + self_other 
                   + affect, data = well_being_df)
summary(best_fit_SWB)
anova(best_fit_SWB)
modelAssumptions(best_fit_SWB)
```

Run a probability distribution to check residuals for homos
```{r Probability Plot}

pwi.residuals <- rstandard(model4)
qqnorm(pwi.residuals, 
       ylab="Standardized Residuals", 
       xlab="Normal Scores", 
       main="Personal Wellbeing Index")

#qqline(as.data.frame(pwi.residuals))
```

## Questions to answer:
# 1. How much variance do the Ivs account for, together in the DV:R^2
# 2. What is the relative importance for each of the Ivs in the model: Beta weights
# 3. Which IV contributes the most unique variance to prediction of the DV: Check sr^2
# 4. How much improvement in the model occurs when we add an additional IV or group of Ivs: Check R^2 Change

```{r}
# Using the Broom library I can pull the model estimates from an assigned object 
# as needed. 
m1 <- glance(model1)
m2 <- glance(model2)
m3 <- glance(model3)
m4 <- glance(model4)

Descriptives <- tibble::tribble(
  ~model, ~R2, ~adj.R2,
  "Model 1",  round(m1$r.squared, digits = 2),  round(m1$adj.r.squared, digits = 2),
  "Model 2*",  round(m2$r.squared, digits = 2), round(m2$adj.r.squared, digits = 2),
  "Model 3",   round(m3$r.squared, digits = 2), round(m3$adj.r.squared, digits = 2),
  "Model 4*",   round(m4$r.squared, digits = 2), round(m4$adj.r.squared, digits = 2)
)

require(rhandsontable)
rhandsontable(Descriptives, rowHeaders = NULL,
               digits = 3, useTypes = FALSE, search = FALSE,
               width = NULL, height = NULL)

```


```{r Papaja Table}
x <- glance(model4)

descriptivez <- well_being_df %>% 
  summarize(
    R_Square = x$r.squared
    , Ajusted_R = x$adj.r.squared , SIGMA = x$sigma
    , PValue = x$p.value
    , Residual = x$df.residual
  )

descriptivez[, -1] <- printnum(descriptivez[, -1])
apa_table(
  descriptivez, 
  format = "html",
  caption = "Descriptive statistics." , 
  note = "This table was created with apa_table"
)

# apa_lm <- apa_print(my_lm)

```
 


Affect was the strongest predictor on SWB followed by self_other then self_Wants. 
Model 2 was sig with MDT as a group however,
Model 4 was significant model accounting for 62% variance in SWB and
affect was the strongest unique contributor to SWB followed by self.future.
Personality was not a significant contributor ... 

```{r}
toc()
```

